name: CI Test

on:
  push:
    branches: 
      - dev
  pull_request:
    branches: 
      - dev

jobs:
  # ğŸ› ï¸ Job 1: Build & Upload Artifact
  test:
    runs-on: ubuntu-latest
    name: Test
    timeout-minutes: 10
    steps:
      # 1ï¸âƒ£ Láº¥y code tá»« repo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2ï¸âƒ£ CÃ i Ä‘áº·t Node.js & Cache
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "yarn"

      # 3ï¸âƒ£ CÃ i Ä‘áº·t dependencies
      - name: Install dependencies
        run: yarn install --frozen-lockfile

      # 4ï¸âƒ£ Cháº¡y Unit Test + Coverage
      - name: Run Tests
        run: yarn test

      # 5ï¸âƒ£ Upload Coverage Artifact
      - name: Upload Test Coverage
        uses: actions/upload-artifact@v4
        with:
          name: test-coverage
          path: coverage/

  # ğŸš€ Job 2: Download Artifact       
  build:
    needs: test # âœ… Chá»‰ cháº¡y build náº¿u test PASSED
    name: Build
    timeout-minutes: 15
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Láº¥y code tá»« repo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Thiáº¿t láº­p cache Ä‘á»ƒ tÄƒng tá»‘c build
      - name: Setup Cache for Turbo & Node.js
        uses: actions/cache@v4
        with:
          path: |
            .turbo
            **/node_modules/.cache/turbo
          key: ${{ runner.os }}-turbo-${{ hashFiles('**/package-lock.json', '**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      # 3ï¸âƒ£ Ghi log thá»i gian báº¯t Ä‘áº§u
      - name: Log Start Time
        run: echo "Workflow started at $(date)"

      # 4ï¸âƒ£ CÃ i Ä‘áº·t Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "yarn"

      # 5ï¸âƒ£ CÃ i Ä‘áº·t dependencies
      - name: Install dependencies
        run: yarn install --frozen-lockfile

      # 6ï¸âƒ£ Cháº¡y build & Ä‘o thá»i gian cháº¡y
      - name: Build Application
        run: |
          START_TIME=$(date +%s)
          yarn turbo run build --affected --cache-dir=.turbo
          END_TIME=$(date +%s)
          echo "Build completed in $((END_TIME - START_TIME)) seconds"

      # 7ï¸âƒ£ LÆ°u trá»¯ artifact Ä‘á»ƒ dÃ¹ng trong cÃ¡c workflow khÃ¡c
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: apps/

      # 8ï¸âƒ£ CÃ i Ä‘áº·t Cosign Ä‘á»ƒ kÃ½ artifact
      # - name: Install Cosign
      #   uses: sigstore/cosign-installer@v3

      # 9ï¸âƒ£ KÃ½ vÃ  táº¡o attestation cho artifact
      # - name: Generate Attestation
      #   run: |
      #     echo "${{ secrets.COSIGN_PRIVATE_KEY }}" > cosign.key
      #     cosign sign-blob --key cosign.key --output-signature build.sig apps/
      #   env:
      #     COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}

      # ğŸ”Ÿ Ghi log tá»•ng thá»i gian cháº¡y
      - name: Log End Time
        run: echo "Workflow completed at $(date)"

      # ğŸ”´ Cleanup (luÃ´n cháº¡y Ä‘á»ƒ dá»n dáº¹p)
      - name: Cleanup Old Caches
        if: always()
        run: rm -rf .turbo

  # ğŸš€ Job 3: Deploy lÃªn Verce      
  deploy:
      needs: build # Chá»‰ cháº¡y khi build xong
      runs-on: ubuntu-latest
      steps:
        - name: Download Build Artifact
          uses: actions/download-artifact@v4
          with:
            name: build-artifact
            path: .next/

        - name: Install Vercel CLI
          run: npm install -g vercel

        - name: Deploy to Vercel
          run: vercel --token ${{ secrets.VERCEL_TOKEN }} --prod --confirm